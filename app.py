import streamlit as st
import random
import base64
from PIL import Image

# Configuration de la page
st.set_page_config(page_title="ğŸŒ TsunamiGuard Pro", page_icon="ğŸŒŠ", layout="wide")

# ==================== SYSTÃˆME MULTILINGUE ====================

LANGUAGES = {
    "FranÃ§ais": "fr",
    "English": "en", 
    "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©": "ar"
}

# Dictionnaire multilingue
MULTILINGUAL_KNOWLEDGE = {
    "fr": {
        "tsunami": {
            "definition": "ğŸŒŠ **Un tsunami** est une sÃ©rie de vagues ocÃ©aniques extrÃªmement longues gÃ©nÃ©rÃ©es par le dÃ©placement soudain d'un grand volume d'eau.",
            "details": "Les tsunamis peuvent voyager Ã  800 km/h en eau profonde et atteindre 30m de haut prÃ¨s des cÃ´tes."
        },
        "welcome": "ğŸŒŠ Bonjour ! Je suis Expert TsunamiGuard. Je peux vous renseigner sur les tsunamis, la sÃ©curitÃ© et l'apport de la gÃ©omatique.",
        "suggested_questions": "ğŸ’¡ Questions suggÃ©rÃ©es",
        "emergency": "ğŸ“ Urgence"
    },
    "en": {
        "tsunami": {
            "definition": "ğŸŒŠ **A tsunami** is a series of extremely long ocean waves generated by the sudden displacement of a large volume of water.",
            "details": "Tsunamis can travel at 800 km/h in deep water and reach 30m high near coasts."
        },
        "welcome": "ğŸŒŠ Hello! I am TsunamiGuard Expert. I can inform you about tsunamis, safety, and geomatics applications.",
        "suggested_questions": "ğŸ’¡ Suggested Questions", 
        "emergency": "ğŸ“ Emergency"
    },
    "ar": {
        "tsunami": {
            "definition": "ğŸŒŠ **ØªØ³ÙˆÙ†Ø§Ù…ÙŠ** Ù‡Ùˆ Ø³Ù„Ø³Ù„Ø© Ù…Ù† Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ù‹Ø§ Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ø§Ù†Ø²ÙŠØ§Ø­ Ø§Ù„Ù…ÙØ§Ø¬Ø¦ Ù„Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ø§Ø¡.",
            "details": "ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙ†ØªÙ‚Ù„ Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„ØªØ³ÙˆÙ†Ø§Ù…ÙŠ Ø¨Ø³Ø±Ø¹Ø© 800 ÙƒÙ…/Ø³Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ‚Ø© ÙˆØªØµÙ„ Ø¥Ù„Ù‰ 30 Ù…ØªØ±Ù‹Ø§ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ø³ÙˆØ§Ø­Ù„."
        },
        "welcome": "ğŸŒŠ Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø®Ø¨ÙŠØ± ØªØ³ÙˆÙ†Ø§Ù…ÙŠ Ø¬Ø§Ø±Ø¯. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¥Ø·Ù„Ø§Ø¹Ùƒ Ø¹Ù„Ù‰ Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„ØªØ³ÙˆÙ†Ø§Ù…ÙŠ ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³.",
        "suggested_questions": "ğŸ’¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©",
        "emergency": "ğŸ“ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦"
    }
}

# ==================== BASE DE CONNAISSANCES AVANCÃ‰E ====================

KNOWLEDGE_BASE = {
    "tsunami": {
        "keywords": ["tsunami", "Ù…ÙˆØ¬Ø©", "wave", "ØªØ³ÙˆÙ†Ø§Ù…ÙŠ"],
        "responses": {
            "fr": "ğŸŒŠ **Un tsunami** est une sÃ©rie de vagues ocÃ©aniques extrÃªmement longues. Vitesse: 800 km/h, Hauteur: jusqu'Ã  30m.",
            "en": "ğŸŒŠ **A tsunami** is a series of extremely long ocean waves. Speed: 800 km/h, Height: up to 30m.", 
            "ar": "ğŸŒŠ **ØªØ³ÙˆÙ†Ø§Ù…ÙŠ** Ù‡Ùˆ Ø³Ù„Ø³Ù„Ø© Ù…Ù† Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ù‹Ø§. Ø§Ù„Ø³Ø±Ø¹Ø©: 800 ÙƒÙ…/Ø³Ø§Ø¹Ø©ØŒ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: Ø­ØªÙ‰ 30 Ù…ØªØ±Ù‹Ø§."
        }
    },
    "causes": {
        "keywords": ["cause", "provoque", "Ø³Ø¨Ø¨", "origin", "why", "Ù„Ù…Ø§Ø°Ø§"],
        "responses": {
            "fr": "ğŸ“Œ **Causes principales :**\nâ€¢ SÃ©ismes sous-marins (90%)\nâ€¢ Glissements de terrain\nâ€¢ Ã‰ruptions volcaniques\nâ€¢ Impacts de mÃ©tÃ©orites",
            "en": "ğŸ“Œ **Main causes:**\nâ€¢ Undersea earthquakes (90%)\nâ€¢ Landslides\nâ€¢ Volcanic eruptions\nâ€¢ Meteorite impacts",
            "ar": "ğŸ“Œ **Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**\nâ€¢ Ø§Ù„Ø²Ù„Ø§Ø²Ù„ ØªØ­Øª Ø§Ù„Ø¨Ø­Ø± (90Ùª)\nâ€¢ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¶ÙŠØ©\nâ€¢ Ø§Ù„Ø«ÙˆØ±Ø§Øª Ø§Ù„Ø¨Ø±ÙƒØ§Ù†ÙŠØ©\nâ€¢ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†ÙŠØ§Ø²Ùƒ"
        }
    },
    "safety": {
        "keywords": ["sÃ©curitÃ©", "safety", "Ø£Ù…Ø§Ù†", "danger", "Ø®Ø·Ø±", "que faire", "what to do", "Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„"],
        "responses": {
            "fr": "ğŸ›¡ï¸ **5 RÃˆGLES D'OR :**\n1. Ã‰loignez-vous du rivage\n2. Gagnez les hauteurs (>15m)\n3. Ne prenez pas la voiture\n4. Ne retournez pas\n5. Restez informÃ©",
            "en": "ğŸ›¡ï¸ **5 GOLDEN RULES:**\n1. Move away from shore\n2. Reach high ground (>15m)\n3. Don't take car\n4. Don't go back\n5. Stay informed", 
            "ar": "ğŸ›¡ï¸ **5 Ù‚ÙˆØ§Ø¹Ø¯ Ø°Ù‡Ø¨ÙŠØ©:**\n1. Ø§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø´Ø§Ø·Ø¦\n2. Ø§ØªØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ØªÙØ¹Ø§Øª (>15Ù…)\n3. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©\n4. Ù„Ø§ ØªØ¹ÙˆØ¯\n5. Ø§Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ø·Ù„Ø§Ø¹"
        }
    },
    "geomatics": {
        "keywords": ["gÃ©omatique", "geomatics", "Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³", "SIG", "GIS", "cartographie", "mapping", "Ø®Ø±Ø§Ø¦Ø·"],
        "responses": {
            "fr": "ğŸ—ºï¸ **RÃ´le de la gÃ©omatique :**\nâ€¢ Cartographie des risques\nâ€¢ ModÃ©lisation SIG\nâ€¢ Plans d'Ã©vacuation\nâ€¢ Surveillance temps rÃ©el",
            "en": "ğŸ—ºï¸ **Geomatics role:**\nâ€¢ Risk mapping\nâ€¢ GIS modeling\nâ€¢ Evacuation plans\nâ€¢ Real-time monitoring",
            "ar": "ğŸ—ºï¸ **Ø¯ÙˆØ± Ø§Ù„Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³:**\nâ€¢ Ø±Ø³Ù… Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø®Ø§Ø·Ø±\nâ€¢ Ù†Ù…Ø°Ø¬Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©\nâ€¢ Ø®Ø·Ø· Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡\nâ€¢ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ"
        }
    }
}

# ==================== FONCTIONS INTELLIGENTES ====================

def get_best_response(user_input, language):
    """Trouve la meilleure rÃ©ponse basÃ©e sur les mots-clÃ©s"""
    user_input = user_input.lower()
    
    # Recherche par mots-clÃ©s
    for topic, data in KNOWLEDGE_BASE.items():
        for keyword in data["keywords"]:
            if keyword.lower() in user_input:
                return data["responses"][language]
    
    # RÃ©ponses par dÃ©faut selon la langue
    default_responses = {
        "fr": [
            "ğŸŒŠ Posez-moi des questions sur: causes, sÃ©curitÃ©, ou gÃ©omatique!",
            "ğŸ¤” Essayez: 'Que faire en cas de tsunami?' ou 'RÃ´le de la gÃ©omatique?'"
        ],
        "en": [
            "ğŸŒŠ Ask me about: causes, safety, or geomatics!",
            "ğŸ¤” Try: 'What to do in tsunami?' or 'Geomatics role?'"
        ],
        "ar": [
            "ğŸŒŠ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù†: Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ØŒ Ø§Ù„Ø³Ù„Ø§Ù…Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³!",
            "ğŸ¤” Ø¬Ø±Ø¨: 'Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙ†Ø§Ù…ÙŠØŸ' Ø£Ùˆ 'Ø¯ÙˆØ± Ø§Ù„Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³ØŸ'"
        ]
    }
    
    return random.choice(default_responses[language])

def display_media(media_type):
    """Affiche images ou vidÃ©os Ã©ducatives"""
    if media_type == "tsunami_diagram":
        st.image("https://i.imgur.com/abc123.png", caption="SchÃ©ma de formation d'un tsunami")
    elif media_type == "evacuation_map":
        st.image("https://i.imgur.com/xyz789.png", caption="Carte d'Ã©vacuation type")

def get_suggested_questions(language):
    """Retourne les questions suggÃ©rÃ©es selon la langue"""
    questions = {
        "fr": [
            "Qu'est-ce qu'un tsunami?",
            "Que faire en cas d'alerte?",
            "RÃ´le de la gÃ©omatique?",
            "Causes principales?"
        ],
        "en": [
            "What is a tsunami?",
            "What to do in alert?",
            "Geomatics role?",
            "Main causes?"
        ],
        "ar": [
            "Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØªØ³ÙˆÙ†Ø§Ù…ÙŠØŸ",
            "Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±ØŸ",
            "Ø¯ÙˆØ± Ø§Ù„Ø¬ÙŠÙˆÙ…Ø§ØªÙƒØ³ØŸ",
            "Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ"
        ]
    }
    return questions[language]

# ==================== INTERFACE STREAMLIT ====================

# Sidebar pour la sÃ©lection de langue
with st.sidebar:
    st.header("ğŸŒ Language / Ø§Ù„Ù„ØºØ©")
    selected_language = st.radio("Choisir la langue / Select language / Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©", 
                               list(LANGUAGES.keys()))
    
    current_lang = LANGUAGES[selected_language]
    
    st.header(MULTILINGUAL_KNOWLEDGE[current_lang]["suggested_questions"])
    for question in get_suggested_questions(current_lang):
        st.write(f"â€¢ {question}")
    
    st.header(MULTILINGUAL_KNOWLEDGE[current_lang]["emergency"])
    st.markdown("**112** (Europe) / **911** (US) / **999** (UK)")

# Interface principale
st.title("ğŸŒ TsunamiGuard Pro - Multilingual Expert")
st.markdown("**Chatbot expert en tsunamis, sÃ©curitÃ© et gÃ©omatique**")

# Section mÃ©dias
with st.expander("ğŸ“¸ **MÃ©dias Ã©ducatifs / Educational Media / Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©**"):
    col1, col2 = st.columns(2)
    with col1:
        st.write("**Diagramme de formation / Formation diagram / Ù…Ø®Ø·Ø· Ø§Ù„ØªØ´ÙƒÙŠÙ„**")
        # Lien vers image Ã©ducative
        st.markdown("[ğŸ“Š Voir le diagramme](https://example.com/tsunami-diagram)")
    with col2:
        st.write("**VidÃ©o Ã©ducative / Educational video / ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ**")
        # Lien vers vidÃ©o YouTube Ã©ducative
        st.markdown("[ğŸ¥ Regarder la vidÃ©o](https://youtube.com/tsunami-education)")

# Historique de conversation
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": MULTILINGUAL_KNOWLEDGE[current_lang]["welcome"]}
    ]

# Affichage de l'historique
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        # Support pour l'arabe (alignement Ã  droite)
        if current_lang == "ar":
            st.markdown(f"<div dir='rtl' style='text-align: right;'>{message['content']}</div>", unsafe_allow_html=True)
        else:
            st.markdown(message["content"])

# Zone de saisie
if prompt := st.chat_input(f"Posez votre question / Ask your question / Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ..."):
    # Ajout du message utilisateur
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        if current_lang == "ar":
            st.markdown(f"<div dir='rtl' style='text-align: right;'>{prompt}</div>", unsafe_allow_html=True)
        else:
            st.markdown(prompt)
    
    # GÃ©nÃ©ration de la rÃ©ponse intelligente
    response = get_best_response(prompt, current_lang)
    
    # Ajout de la rÃ©ponse
    st.session_state.messages.append({"role": "assistant", "content": response})
    with st.chat_message("assistant"):
        if current_lang == "ar":
            st.markdown(f"<div dir='rtl' style='text-align: right;'>{response}</div>", unsafe_allow_html=True)
        else:
            st.markdown(response)

# Footer informatif
st.markdown("---")
st.markdown("ğŸ”¬ *DÃ©veloppÃ© par des Ã©tudiants en gÃ©oinformatique - Projet Ã©ducatif*")

# Section d'information rapide
st.sidebar.markdown("---")
st.sidebar.info(
    "ğŸ’¡ **Conseil:** Utilisez des mots-clÃ©s comme 'sÃ©curitÃ©', 'causes', "
    "'gÃ©omatique' pour des rÃ©ponses prÃ©cises."
)
