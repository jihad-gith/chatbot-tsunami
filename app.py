import streamlit as st
import random
import base64
from PIL import Image, ImageDraw
import io
import time

# Configuration de la page
st.set_page_config(
    page_title="🌊 Tsunami Expert", 
    page_icon="🌊", 
    layout="wide"
)

# ==================== STYLE MODERNE ====================
st.markdown("""
<style>
    .main-header {
        font-size: 2.8rem;
        color: #1e88e5;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: bold;
    }
    .chat-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .sidebar-content {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin: 12px 0;
        border-left: 4px solid #1e88e5;
    }
    .emergency-box {
        background: linear-gradient(135deg, #ff5252, #d32f2f);
        color: white;
        padding: 18px;
        border-radius: 12px;
        text-align: center;
        font-weight: bold;
    }
    .question-btn {
        background: linear-gradient(135deg, #4caf50, #2e7d32);
        color: white;
        border: none;
        padding: 12px 18px;
        border-radius: 10px;
        margin: 6px 0;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 0.9em;
        text-align: left;
    }
    .question-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76,175,80,0.3);
    }
    .arabic-text {
        direction: rtl;
        text-align: right;
        line-height: 1.8;
        font-size: 1.05em;
    }
    .category-header {
        color: #1e88e5;
        border-bottom: 2px solid #1e88e5;
        padding-bottom: 8px;
        margin-top: 20px;
        font-weight: bold;
    }
</style>
""", unsafe_allow_html=True)

# ==================== SYSTÈME MULTILINGUE ====================

LANGUAGES = {
    "🇫🇷 Français": "fr",
    "🇬🇧 English": "en", 
    "🇸🇦 العربية": "ar"
}

# ==================== BASE DE CONNAISSANCES AMÉLIORÉE ====================

KNOWLEDGE_BASE = {
    # ========== DÉFINITION ET CAUSES ==========
    "definition_tsunami": {
        "keywords": {
            "fr": ["définition", "qu'est-ce", "c'est quoi", "explique", "définir", "quoi", "tsunami"],
            "en": ["definition", "what is", "explain", "define", "what", "tsunami"],
            "ar": ["تعريف", "ما هو", "شرح", "ماهو", "ما", "تسونامي"]
        },
        "responses": {
            "fr": """
**🌊 DÉFINITION DU TSUNAMI**

Un **tsunami** (mot japonais signifiant "vague du port") est une série de vagues océaniques extrêmement longues générées par le déplacement soudain d'un grand volume d'eau.

**Caractéristiques principales :**
- **Vitesse** : 500-800 km/h en eau profonde (comme un avion de ligne)
- **Hauteur** : 30 cm à 1m en mer → 10-30m près des côtes
- **Longueur d'onde** : 100-200 km (vs 100m pour une vague normale)
- **Période** : 10-60 minutes entre les vagues successives

**Mécanisme physique :** Le déplacement vertical du fond marin pousse toute la colonne d'eau, créant des ondes qui se propagent dans toutes les directions.
            """,
            "en": """
**🌊 TSUNAMI DEFINITION**

A **tsunami** (Japanese for "harbor wave") is a series of extremely long ocean waves generated by the sudden displacement of a large volume of water.

**Key characteristics:**
- **Speed**: 500-800 km/h in deep water (like a jet airliner)
- **Height**: 30 cm to 1m at sea → 10-30m near coasts
- **Wavelength**: 100-200 km (vs 100m for normal wave)
- **Period**: 10-60 minutes between successive waves

**Physical mechanism**: Vertical seabed displacement pushes the entire water column, creating waves that propagate in all directions.
            """,
            "ar": """
**🌊 تعريف التسونامي**

**التسونامي** (كلمة يابانية تعني "موجة الميناء") هو سلسلة من أمواج المحيط الطويلة جدًا الناتجة عن الانزياح المفاجئ لحجم كبير من الماء.

**الخصائص الرئيسية:**
- **السرعة**: 500-800 كم/ساعة في المياه العميقة (مثل الطائرة النفاثة)
- **الارتفاع**: 30 سم إلى 1م في البحر → 10-30م بالقرب من السواحل
- **الطول الموجي**: 100-200 كم (مقابل 100م للموجة العادية)
- **الفترة**: 10-60 دقيقة بين الأمواج المتتالية

**الآلية الفيزيائية**: الانزياح الرأسي لقاع البحر يدفع عمود الماء بالكامل، مكونًا موجات تنتشر في جميع الاتجاهات.
            """
        }
    },
    
    "difference_vague_tsunami": {
        "keywords": {
            "fr": ["différence", "comparaison", "vague normale", "vague vs tsunami", "différent"],
            "en": ["difference", "compare", "normal wave", "wave vs tsunami", "different"],
            "ar": ["فرق", "مقارنة", "موجة عادية", "موجة مقابل تسونامي", "مختلف"]
        },
        "responses": {
            "fr": """
**🌊 DIFFÉRENCE ENTRE TSUNAMI ET VAGUE NORMALE**

| Caractéristique | Vague Normale | Tsunami |
|-----------------|---------------|---------|
| **Cause** | Vent | Séisme/Glissement |
| **Longueur d'onde** | 100-200 m | 100-200 km |
| **Vitesse** | 10-60 km/h | 500-800 km/h |
| **Période** | 5-20 secondes | 10-60 minutes |
| **Énergie** | Surface | Colonne d'eau entière |
| **Comportement** | Brise sur plage | Inonde terres |

**Point crucial :** Une vague normale ne déplace que l'eau de surface, tandis qu'un tsunami déplace TOUTE la colonne d'eau du fond à la surface.
            """,
            "en": """
**🌊 DIFFERENCE BETWEEN TSUNAMI AND NORMAL WAVE**

| Characteristic | Normal Wave | Tsunami |
|----------------|-------------|---------|
| **Cause** | Wind | Earthquake/Landslide |
| **Wavelength** | 100-200 m | 100-200 km |
| **Speed** | 10-60 km/h | 500-800 km/h |
| **Period** | 5-20 seconds | 10-60 minutes |
| **Energy** | Surface | Entire water column |
| **Behavior** | Breaks on beach | Floods inland |

**Key point:** A normal wave only moves surface water, while a tsunami moves the ENTIRE water column from bottom to surface.
            """,
            "ar": """
**🌊 الفرق بين التسونامي والموجة العادية**

| الخاصية | الموجة العادية | التسونامي |
|----------|----------------|-----------|
| **السبب** | الرياح | الزلزال/الانهيار |
| **الطول الموجي** | 100-200 م | 100-200 كم |
| **السرعة** | 10-60 كم/ساعة | 500-800 كم/ساعة |
| **الفترة** | 5-20 ثانية | 10-60 دقيقة |
| **الطاقة** | السطح | عمود الماء بالكامل |
| **السلوك** | ينكسر على الشاطئ | يغمر اليابسة |

**النقطة الأساسية:** الموجة العادية تحرك فقط مياه السطح، بينما التسونامي يحرك عمود الماء بالكامل من القاع إلى السطح.
            """
        }
    },
    
    "causes_principales": {
        "keywords": {
            "fr": ["causes", "origines", "pourquoi", "provoque", "cause tsunami", "origine tsunami"],
            "en": ["causes", "origins", "why", "cause", "tsunami causes", "tsunami origins"],
            "ar": ["أسباب", "مصادر", "لماذا", "يتسبب", "أسباب تسونامي", "مصادر تسونامي"]
        },
        "responses": {
            "fr": """
**📌 CAUSES PRINCIPALES DES TSUNAMIS**

**1. SÉISMES SOUS-MARINS (90% des cas)**
- **Magnitude minimale** : > 6.5 sur l'échelle de Richter
- **Type de faille** : Mouvement vertical essentiellement
- **Exemple** : Japon 2011 (magnitude 9.0), Sumatra 2004 (9.1)

**2. GLISSEMENTS DE TERRAIN SOUS-MARINS (7%)**
- **Volume** : Peut atteindre des kilomètres cubes
- **Localisation** : Pentes continentales, volcans sous-marins
- **Exemple** : Papouasie-Nouvelle-Guinée 1998

**3. ÉRUPTIONS VOLCANIQUES (2%)**
- **Mécanisme** : Effondrement du volcan, entrée de matériaux
- **Exemple** : Krakatoa 1883 (vagues de 40m)

**4. IMPACTS DE MÉTÉORITES (1%)**
- **Rareté** : Événements exceptionnels
- **Énergie** : Extrêmement destructrice

**5. AUTRES CAUSES** : Explosions nucléaires sous-marines, effondrements glaciaires
            """,
            "en": """
**📌 MAIN TSUNAMI CAUSES**

**1. UNDERSEA EARTHQUAKES (90% of cases)**
- **Minimum magnitude**: > 6.5 on Richter scale
- **Fault type**: Primarily vertical movement
- **Example**: Japan 2011 (magnitude 9.0), Sumatra 2004 (9.1)

**2. SUBMARINE LANDSLIDES (7%)**
- **Volume**: Can reach cubic kilometers
- **Location**: Continental slopes, underwater volcanoes
- **Example**: Papua New Guinea 1998

**3. VOLCANIC ERUPTIONS (2%)**
- **Mechanism**: Volcano collapse, material entry
- **Example**: Krakatoa 1883 (40m waves)

**4. METEORITE IMPACTS (1%)**
- **Rarity**: Exceptional events
- **Energy**: Extremely destructive

**5. OTHER CAUSES**: Underwater nuclear explosions, glacial collapses
            """,
            "ar": """
**📌 الأسباب الرئيسية للتسونامي**

**1. الزلازل تحت البحر (90٪ من الحالات)**
- **الحد الأدنى للقوة**: > 6.5 على مقياس ريختر
- **نوع الصدع**: حركة رأسية primarily
- **مثال**: اليابان 2011 (قوة 9.0)، سومطرة 2004 (9.1)

**2. الانهيارات الأرضية تحت البحر (7٪)**
- **الحجم**: يمكن أن يصل إلى كيلومترات مكعبة
- **الموقع**: المنحدرات القارية، البراكين تحت الماء
- **مثال**: بابوا غينيا الجديدة 1998

**3. الثورات البركانية (2٪)**
- **الآلية**: انهيار البركان، دخول المواد
- **مثال**: كراكاتوا 1883 (أمواج 40م)

**4. اصطدام النيازك (1٪)**
- **الندرة**: أحداث استثنائية
- **الطاقة**: مدمرة للغاية

**5. أسباب أخرى**: انفجارات نووية تحت الماء، انهيارات جليدية
            """
        }
    },
    
    "seisme_tsunami": {
        "keywords": {
            "fr": ["séisme", "tremblement de terre", "comment séisme", "mécanisme séisme", "séisme provoque"],
            "en": ["earthquake", "how earthquake", "mechanism earthquake", "earthquake causes"],
            "ar": ["زلزال", "كيف زلزال", "آلية زلزال", "زلزال يتسبب"]
        },
        "responses": {
            "fr": """
**🔬 COMMENT UN SÉISME PROVOQUE UN TSUNAMI**

**Processus en 4 étapes :**

**1. RUPTURE SOUS-MARINE**
- Faille tectonique se rompt sous l'océan
- Déplacement vertical du plancher océanique (jusqu'à 10m)
- Temps : Quelques secondes à minutes

**2. DÉPLACEMENT D'EAU**
- La colonne d'eau est poussée vers le haut ou tirée vers le bas
- Création d'une "bosse" d'eau à la surface
- Énergie transmise à toute la colonne d'eau

**3. PROPAGATION DES ONDES**
- Ondes se propagent à 800 km/h en eau profonde
- Longue distance avec peu de perte d'énergie
- Amplification près des côtes

**4. DÉFERLEMENT CÔTIER**
- Ralentissement en eau peu profonde
- Amplitude des vagues multipliée par 10-30
- Inondation des terres

**Conditions nécessaires :**
- Magnitude > 6.5
- Faille à mouvement vertical
- Profondeur < 50 km
            """,
            "en": """
**🔬 HOW AN EARTHQUAKE CAUSES A TSUNAMI**

**4-step process:**

**1. UNDERSEA RUPTURE**
- Tectonic fault breaks under ocean
- Vertical displacement of ocean floor (up to 10m)
- Time: Few seconds to minutes

**2. WATER DISPLACEMENT**
- Water column pushed upward or pulled downward
- Creation of water "bulge" at surface
- Energy transmitted to entire water column

**3. WAVE PROPAGATION**
- Waves propagate at 800 km/h in deep water
- Long distance with little energy loss
- Amplification near coasts

**4. COASTAL BREAKING**
- Slowing in shallow water
- Wave amplitude multiplied by 10-30
- Land flooding

**Required conditions:**
- Magnitude > 6.5
- Vertical movement fault
- Depth < 50 km
            """,
            "ar": """
**🔬 كيف يتسبب الزلزال في تسونامي**

**عملية من 4 خطوات:**

**1. تمزق تحت البحر**
- انكسار الصدع التكتوني تحت المحيط
- الانزياح الرأسي لقاع المحيط (حتى 10م)
- الوقت: بضع ثوان إلى دقائق

**2. إزاحة الماء**
- دفع عمود الماء لأعلى أو سحبه لأسفل
- تكوين "انتفاخ" مائي على السطح
- نقل الطاقة إلى عمود الماء بالكامل

**3. انتشار الموج**
- انتشار الأمواج بسرعة 800 كم/ساعة في المياه العميقة
- مسافة طويلة مع فقدان طاقة قليل
- تضخيم بالقرب من السواحل

**4. انكسار ساحلي**
- التباطؤ في المياه الضحلة
- تضخيم سعة الموجة 10-30 مرة
- فيضان اليابسة

**الشروط المطلوبة:**
- قوة > 6.5
- صدع بحركة رأسية
- عمق < 50 كم
            """
        }
    },
    
    "volcan_glissement_tsunami": {
        "keywords": {
            "fr": ["volcan", "volcanique", "glissement", "éruption", "volcan tsunami", "glissement terrain"],
            "en": ["volcano", "volcanic", "landslide", "eruption", "volcano tsunami", "landslide tsunami"],
            "ar": ["بركان", "بركاني", "انهيار", "ثوران", "بركان تسونامي", "انهيار أرضي"]
        },
        "responses": {
            "fr": """
**🌋 TSUNAMIS VOLCANIQUES ET PAR GLISSEMENTS**

**TSUNAMIS VOLCANIQUES :**

**Mécanismes :**
1. **Effondrement du volcan** - Flancs qui s'effondrent dans la mer
2. **Pyroclastiques** - Flux de matériaux entrant dans l'eau
3. **Explosions sous-marines** - Vapeur et gaz sous pression

**Exemples célèbres :**
- **Krakatoa 1883** : Vagues de 40m, 36,000 morts
- **Santorin 1600 av.J-C** : Possible fin de la civilisation minoenne

**TSUNAMIS PAR GLISSEMENTS :**

**Types de glissements :**
- **Sous-marins** : Effondrement pentes continentales
- **Aériens** : Roches/glaciers tombant dans fjords/lacs

**Caractéristiques :**
- Plus localisés mais très destructeurs localement
- Peuvent survenir sans séisme préalable
- Difficiles à prévoir

**Exemple :** Baie Lituya 1958 - Vague de 524m (record mondial)
            """,
            "en": """
**🌋 VOLCANIC AND LANDSLIDE TSUNAMIS**

**VOLCANIC TSUNAMIS:**

**Mechanisms:**
1. **Volcano collapse** - Flanks collapsing into sea
2. **Pyroclastics** - Material flows entering water
3. **Underwater explosions** - Steam and pressurized gas

**Famous examples:**
- **Krakatoa 1883**: 40m waves, 36,000 deaths
- **Santorini 1600 BC**: Possible end of Minoan civilization

**LANDSLIDE TSUNAMIS:**

**Landslide types:**
- **Submarine**: Continental slope collapses
- **Aerial**: Rocks/glaciers falling into fjords/lakes

**Characteristics:**
- More localized but very destructive locally
- Can occur without prior earthquake
- Difficult to predict

**Example:** Lituya Bay 1958 - 524m wave (world record)
            """,
            "ar": """
**🌋 تسونامي البراكين والانهيارات**

**تسونامي البراكين:**

**الآليات:**
1. **انهيار البركان** - انهيار الأجنبة في البحر
2. **المواد البركانية** - تدفق المواد إلى الماء
3. **انفجارات تحت الماء** - البخار والغاز المضغوط

**أمثلة مشهورة:**
- **كراكاتوا 1883**: أمواج 40م، 36,000 وفاة
- **سانتوريني 1600 ق.م**: نهاية محتملة للحضارة المينوية

**تسونامي الانهيارات:**

**أنواع الانهيارات:**
- **تحت البحر**: انهيار المنحدرات القارية
- **جوي**: صخور/أنهار جليدية تسقط في المضايق/البحيرات

**الخصائص:**
- أكثر تمركزًا ولكن مدمرة جدًا محليًا
- يمكن أن تحدث بدون زلزال مسبق
- صعبة التنبؤ

**مثال:** خليج ليتويا 1958 - موجة 524م (رقم قياسي عالمي)
            """
        }
    },
    
    "signes_precurseurs": {
        "keywords": {
            "fr": ["signes", "précurseurs", "alerte", "avant tsunami", "signes avant", "reconnaître"],
            "en": ["signs", "warning", "alert", "before tsunami", "warning signs", "recognize"],
            "ar": ["علامات", "إنذار", "قبل تسونامي", "علامات إنذار", "يتعرف"]
        },
        "responses": {
            "fr": """
**⚠️ SIGNES PRÉCURSEURS D'UN TSUNAMI**

**SIGNES NATURELS (À CONNAÎTRE ABSOLUMENT) :**

**1. SÉISME FORT ET LONG**
- Durée > 20 secondes
- Impossible de rester debout
- Secousses violentes

**2. RETRAIT SOUDAIN DE LA MER**
- Mer qui se retire anormalement loin
- Fond marin visible sur des centaines de mètres
- **ATTENTION** : Ce n'est pas le moment de prendre des photos !

**3. BRUIT ANORMAL**
- Bruit de locomotive ou d'avion à réaction
- Grondement sourd venant de l'océan

**4. COMPORTEMENT ANIMAL**
- Animaux qui fuient vers les hauteurs
- Oiseaux qui s'envolent en masse

**SIGNES OFFICIELS :**
- Sirènes d'alerte tsunami
- Messages d'urgence sur téléphone
- Alertes médias et radio

**RÈGLE D'OR :** En cas de séisme côtier, évacuez immédiatement sans attendre les signes visuels !
            """,
            "en": """
**⚠️ TSUNAMI WARNING SIGNS**

**NATURAL SIGNS (MUST KNOW):**

**1. STRONG, LONG EARTHQUAKE**
- Duration > 20 seconds
- Cannot stand upright
- Violent shaking

**2. SUDDEN SEA RETREAT**
- Sea retreating abnormally far
- Seabed visible for hundreds of meters
- **WARNING**: Not the time for photos!

**3. ABNORMAL NOISE**
- Locomotive or jet engine noise
- Deep roar from ocean

**4. ANIMAL BEHAVIOR**
- Animals fleeing to high ground
- Birds flying away en masse

**OFFICIAL SIGNS:**
- Tsunami warning sirens
- Emergency phone messages
- Media and radio alerts

**GOLDEN RULE:** During coastal earthquake, evacuate immediately without waiting for visual signs!
            """,
            "ar": """
**⚠️ علامات إنذار التسونامي**

**العلامات الطبيعية (يجب معرفتها):**

**1. زلزال قوي وطويل**
- المدة > 20 ثانية
- عدم القدرة على الوقوف
- اهتزازات عنيفة

**2. انسحاب مفاجئ للبحر**
- تراجع البحر بشكل غير طبيعي
- قاع البحر مرئي لمئات الأمتار
- **تحذير**: ليس وقتًا لالتقاط الصور!

**3. ضجيج غير طبيعي**
- ضجيج مثل القطار أو المحرك النفاث
- هدير عميق قادم من المحيط

**4. سلوك الحيوان**
- حيوانات تهرب إلى المرتفعات
- طيور تطير بعيدًا بأعداد كبيرة

**العلامات الرسمية:**
- صفارات إنذار التسونامي
- رسائل طوارئ على الهاتف
- تنبيهات الإعلام والراديو

**القاعدة الذهبية:** أثناء الزلزال الساحلي، اخل فورًا دون انتظار العلامات المرئية!
            """
        }
    },
    
    # ========== CONSÉQUENCES ==========
    "consequences_humaines": {
        "keywords": {
            "fr": ["conséquences humaines", "victimes", "morts", "décès", "impact humain"],
            "en": ["human consequences", "victims", "deaths", "human impact"],
            "ar": ["عواقب بشرية", "ضحايا", "وفيات", "تأثير بشري"]
        },
        "responses": {
            "fr": """
**😢 CONSÉQUENCES HUMAINES DES TSUNAMIS**

**IMPACTS IMMÉDIATS :**

**1. MORTS ET BLESSÉS**
- **Noyade** (cause principale de décès)
- **Traumatismes physiques** (fractures, blessures)
- **Hypothermie** en eau froide

**2. DÉPLACEMENTS DE POPULATION**
- Maisons détruites
- Infrastructures endommagées
- Réfugiés environnementaux

**STATISTIQUES :**
- **Tsunami 2004** : 230,000-280,000 morts
- **Japon 2011** : 18,000 morts confirmés
- **Moyenne historique** : Variable selon l'événement

**FACTEURS INFLUENÇANT LA MORTALITÉ :**
- Densité de population côtière
- Heure de la journée (nuit = plus dangereux)
- Systèmes d'alerte en place
- Éducation de la population
            """,
            "en": """
**😢 HUMAN CONSEQUENCES OF TSUNAMIS**

**IMMEDIATE IMPACTS:**

**1. DEATHS AND INJURIES**
- **Drowning** (main cause of death)
- **Physical trauma** (fractures, injuries)
- **Hypothermia** in cold water

**2. POPULATION DISPLACEMENT**
- Homes destroyed
- Damaged infrastructure
- Environmental refugees

**STATISTICS:**
- **2004 tsunami**: 230,000-280,000 deaths
- **Japan 2011**: 18,000 confirmed deaths
- **Historical average**: Varies by event

**FACTORS INFLUENCING MORTALITY:**
- Coastal population density
- Time of day (night = more dangerous)
- Warning systems in place
- Population education
            """,
            "ar": """
**😢 العواقب البشرية للتسونامي**

**الآثار الفورية:**

**1. الوفيات والإصابات**
- **الغرق** (السبب الرئيسي للوفاة)
- **الصدمات الجسدية** (كسور، إصابات)
- **انخفاض حرارة الجسم** في الماء البارد

**2. نزوح السكان**
- تدمير المنازل
- تلف البنية التحتية
- لاجئون بيئيون

**الإحصائيات:**
- **تسونامي 2004**: 230,000-280,000 وفاة
- **اليابان 2011**: 18,000 وفاة مؤكدة
- **المتوسط التاريخي**: يختلف حسب الحدث

**العوامل المؤثرة على الوفيات:**
- كثافة السكان الساحليين
- وقت اليوم (الليل = أكثر خطورة)
- أنظمة الإنذار الموجودة
- تثقيف السكان
            """
        }
    }
}

# ==================== FONCTION DE RECHERCHE AMÉLIORÉE ====================

def find_response(user_input, language):
    """Trouve la réponse la plus pertinente avec reconnaissance améliorée"""
    user_input_lower = user_input.lower()
    
    # Recherche améliorée - vérifie chaque mot-clé individuellement
    best_match = None
    best_score = 0
    
    for category, data in KNOWLEDGE_BASE.items():
        score = 0
        for keyword in data["keywords"][language]:
            if keyword in user_input_lower:
                score += 1
        
        if score > best_score:
            best_score = score
            best_match = category
    
    # Si on a trouvé une bonne correspondance
    if best_score >= 1:
        return KNOWLEDGE_BASE[best_match]["responses"][language]
    
    # Recherche de secours avec mots individuels
    for category, data in KNOWLEDGE_BASE.items():
        for keyword in data["keywords"][language]:
            # Vérifie si des mots individuels correspondent
            words = user_input_lower.split()
            for word in words:
                if word in keyword or keyword in word:
                    return data["responses"][language]
    
    # Réponse par défaut
    default_responses = {
        "fr": "🤖 **Expert Tsunami** - Je n'ai pas compris votre question. Essayez avec : définition, causes, séisme, volcan, conséquences, ou signes avant-coureurs.",
        "en": "🤖 **Tsunami Expert** - I didn't understand your question. Try with: definition, causes, earthquake, volcano, consequences, or warning signs.",
        "ar": "🤖 **خبير التسونامي** - لم أفهم سؤالك. جرب مع: تعريف، أسباب، زلزال، بركان، عواقب، أو علامات إنذار."
    }
    return default_responses[language]

def display_text(text, language):
    """Affiche le texte avec la bonne direction"""
    if language == "ar":
        st.markdown(f'<div class="arabic-text">{text}</div>', unsafe_allow_html=True)
    else:
        st.markdown(text)

# ==================== INTERFACE ====================

# Titre
st.markdown('<div class="main-header">🌊 Expert Tsunami</div>', unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.markdown("### 🌍 Langue")
    selected_language = st.radio("", list(LANGUAGES.keys()), label_visibility="collapsed")
    current_lang = LANGUAGES[selected_language]
    
    # Questions par catégorie
    categories = {
        "fr": {
            "definition": "📚 Définition et Causes",
            "consequences": "💥 Conséquences"
        },
        "en": {
            "definition": "📚 Definition and Causes", 
            "consequences": "💥 Consequences"
        },
        "ar": {
            "definition": "📚 التعريف والأسباب",
            "consequences": "💥 العواقب"
        }
    }
    
    questions_by_category = {
        "definition": {
            "fr": [
                "Qu'est-ce qu'un tsunami ?",
                "Différence avec vague normale", 
                "Causes principales",
                "Comment un séisme provoque un tsunami",
                "Tsunamis volcaniques et glissements",
                "Signes avant-coureurs"
            ],
            "en": [
                "What is a tsunami?",
                "Difference with normal wave",
                "Main causes",
                "How earthquake causes tsunami", 
                "Volcanic and landslide tsunamis",
                "Warning signs"
            ],
            "ar": [
                "ما هو التسونامي؟",
                "الفرق مع الموجة العادية",
                "الأسباب الرئيسية",
                "كيف يتسبب الزلزال في تسونامي",
                "تسونامي البراكين والانهيارات", 
                "علامات الإنذار"
            ]
        },
        "consequences": {
            "fr": [
                "Conséquences humaines",
                "Impacts économiques"
            ],
            "en": [
                "Human consequences", 
                "Economic impacts"
            ],
            "ar": [
                "العواقب البشرية",
                "الآثار الاقتصادية"
            ]
        }
    }
    
    for category_key, category_name in categories[current_lang].items():
        st.markdown(f'<div class="category-header">{category_name}</div>', unsafe_allow_html=True)
        for question in questions_by_category[category_key][current_lang]:
            if st.button(question, key=f"{category_key}_{question}"):
                st.session_state.auto_question = question
    
    st.markdown("---")
    st.markdown("### 🚨 Urgence")
    st.markdown("**Éloignement immédiat**")
    st.markdown("**112 • 911 • 999**")

# Zone de chat
st.markdown('<div class="chat-container">', unsafe_allow_html=True)

# Historique de conversation
if "messages" not in st.session_state:
    welcome_messages = {
        "fr": "🌊 **Expert Tsunami** - Je peux répondre à vos questions sur : définition, causes, conséquences des tsunamis. Utilisez les boutons ou tapez vos questions !",
        "en": "🌊 **Tsunami Expert** - I can answer your questions about: definition, causes, consequences of tsunamis. Use buttons or type your questions!", 
        "ar": "🌊 **خبير التسونامي** - يمكنني الإجابة على أسئلتك عن: تعريف، أسباب، عواقب التسونامي. استخدم الأزرار أو اكتب أسئلتك!"
    }
    st.session_state.messages = [
        {"role": "assistant", "content": welcome_messages[current_lang]}
    ]

# Affichage de l'historique
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        display_text(message["content"], current_lang)

# Gestion des questions automatiques
if "auto_question" in st.session_state:
    prompt = st.session_state.auto_question
    del st.session_state.auto_question
else:
    prompt = None

# Input utilisateur
if prompt or (user_input := st.chat_input("💬 Posez votre question...")):
    
    if not prompt:
        prompt = user_input
    
    # Ajout du message utilisateur
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    # Génération de la réponse
    response = find_response(prompt, current_lang)
    
    # Ajout de la réponse
    st.session_state.messages.append({
        "role": "assistant", 
        "content": response
    })
    
    st.rerun()
